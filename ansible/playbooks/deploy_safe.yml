---
# =========================
# PLAY 1 - BACKUP AND DEPLOY
# =========================

- name: Safe Deploy MikroTik Configuration
  hosts: mikrotik
  gather_facts: false

  vars:
    backup_name: "backup-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:

    - name: Create MikroTik backup
      community.routeros.command:
        commands:
          - "/export file={{ backup_name }}"
      register: backup_result


    - block:

        - name: Deploy IP Address
          ansible.builtin.include_role:
            name: ip_address


        - name: Deploy DHCP
          ansible.builtin.include_role:
            name: dhcp


        - name: Run verification playbook
          ansible.builtin.command:
            cmd: ansible-playbook playbooks/verify.yml
          register: verify_result
          failed_when: verify_result.rc != 0


      rescue:

        - name: Rollback MikroTik config
          community.routeros.command:
            commands:
              - "/import file={{ backup_name }}.rsc"


        - name: Fail after rollback
          ansible.builtin.fail:
            msg: "Deployment failed and rollback executed."


      always:

        - name: Show completion message
          ansible.builtin.debug:
            msg: "Safe deploy finished"
